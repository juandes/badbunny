---
title: "When do I listen to Bad Bunny?"
output: html_notebook
---

```{r}
require(parsedate)
require(lubridate)
require(skimr)
require(dplyr)
require(tidyr)
require(ggplot2)
require(bbplot)
```

```{r}
df <- read.csv("~/Development/badbunny/data/df.csv")
```


```{r}
df$posixct <- as.POSIXct(df$PlayedAt, tz = "UTC", format = "%Y-%m-%dT%H:%M:%OS")

# Assign timezones
# This is for reference only
df$tz[df$posixct < "2019-07-04"] <- "Europe/Berlin"
df$tz[df$posixct >= "2019-07-04" & df$posixct <= "2019-12-16"] <- "Asia/Singapore"
df$tz[df$posixct >= "2019-12-17" & df$posixct <= "2020-07-16"] <- "Pacific/Auckland"
df$tz[df$posixct > "2020-07-16" & df$posixct <= "2022-04-04"] <- "Europe/Berlin"
df$tz[df$posixct > "2022-04-04"] <- "America/Chicago"

# Yes, this is a weird weird to do it but see this: 
# https://stackoverflow.com/questions/41648912/invalid-tz-value-problems-with-time-zone#:~:text=The%20source%20of%20your%20%22invalid,value%2C%20then%20it%20will%20work.
df$posixctd[df$posixct < "2019-07-04"] <- as.character(with_tz(df$posixct[df$posixct < "2019-07-04"], 
                                                 "Europe/Berlin"))
df$posixctd[df$posixct >= "2019-07-04" & df$posixct <= "2019-12-16"] <- as.character(with_tz(df$posixct[df$posixct >= "2019-07-04" & df$posixct <= "2019-12-16"],
                                                                               "Asia/Singapore"))
df$posixctd[df$posixct >= "2019-12-17" & df$posixct <= "2020-07-16"] <- as.character(with_tz(df$posixct[df$posixct >= "2019-12-17" & df$posixct <= "2020-07-16"],
                                                                               "Pacific/Auckland"))
df$posixctd[df$posixct > "2020-07-16" & df$posixct <= "2022-04-04"] <- as.character(with_tz(df$posixct[df$posixct > "2020-07-16" & df$posixct <= "2022-04-04"],
                                                                              "Europe/Berlin"))
df$posixctd[df$posixct > "2022-04-04"] <- as.character(with_tz(df$posixct[df$posixct > "2022-04-04"], 
                                                 "America/Chicago"))
```

```{r}
# How many songs (as of July 26, 2022)
nrow(df)
# I have a total of 67641 songs, so 6.6% percent are from BB.
```


```{r}
# Favorite song
grouped.by.song <- df %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise(n = n(), percentage = (n() / nrow(df)) * 100) %>%
  arrange(desc(n))
```

```{r}
print(grouped.by.song)
```
```{r}
# Longest sequence per day
df$date <- date(df$posixctd)

songs.by.day <- df %>%
  group_by(date) %>%
  summarise(n = n()) %>%
  complete(date = seq.Date(min(date), max(date), by='day'))

songs.by.day[is.na(songs.by.day)] <- 0
# if listened at least once
songs.by.day$listened <- ifelse(songs.by.day$n > 0, TRUE, FALSE)
```

```{r}
sequences <- rle(songs.by.day$n)
r[["lengths"]]
```

```{r}
r[["values"]]
```
```{r}
# Longest streak without BB lasted 91 days started on 2018-03-19 and ended on 2018-06-18
```

```{r}
sequences.bool <- rle(songs.by.day$listened)
```

```{r}
sequences.bool[["lengths"]]
sequences.bool[["values"]]

sequences.df <- data.frame(lengths = sequences.bool[["lengths"]], values = sequences.bool[["values"]])

sum(sequences.bool[["lengths"]][1:215]) #1136

# Longest sequence started on 2021-01-10 and ended on 2021-01-26
```

```{r}
# Statistics about streaks of days when I don't listen to BB
skim(sequences.df[sequences.df$values == FALSE,])
```
```{r}
# Statistics about streaks of days when I listen to BB
skim(sequences.df[sequences.df$values == TRUE,])
```

```{r}
# Day where I listened to him the most
songs.by.day[which.max(songs.by.day$n),] #2021-02-16. Cami was in DD and we listened to "This is Bad Bunny." 
```

```{r}
# What songs did I listen on the day I listened to him the most?
df[df$date == "2021-02-16",] %>%
  group_by(Name) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
```


```{r}
# Stats of days where I listened to him
skim(songs.by.day[songs.by.day$listened == TRUE,])
```
## Weekdays and hours

```{r}
df$weekdays <- weekdays(as.POSIXct(df$posixctd))
df$hour <- hour(as.POSIXct(df$posixctd))
```

```{r}
songs.by.weekday <- df %>%
  select(weekdays) %>%
  group_by(weekdays) %>%
  summarise(n = n(), percentage = (n() / nrow(df)) * 100) %>%
  arrange(desc(n))
print(songs.by.weekday)

# Why not Friday, because Fridays are for Release Radar
```

```{r}
songs.by.hour <- df %>%
  select(hour) %>%
  group_by(hour) %>%
  summarise(n = n(), percentage = (n() / nrow(df)) * 100) %>%
  arrange(desc(n))
print(songs.by.hour)
```
```{r}
songs.by.weekday.hour <- df %>%
  select(weekdays, hour) %>%
  group_by(weekdays, hour) %>%
  summarise(n = n(), percentage = (n() / nrow(df)) * 100, .groups="drop_last") %>%
  arrange(desc(n))
print(songs.by.weekday.hour)
```
```{r}
songs.by.weekday.hour$weekdays <- factor(songs.by.weekday.hour$weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday",  "Friday", 
                                                 "Saturday", "Sunday"))
```

```{r}
p <- ggplot(songs.by.weekday.hour, aes(x = hour, y = weekdays)) +
  geom_point(aes(size = n)) +
  labs(title="Weekdays and times (hour) when I've played Bad Bunny's songs") +
  xlab('Hour') + ylab('Weekday') +
  bbc_style() +
  theme(axis.title = element_text(size = 24), 
        plot.margin = unit(c(1.0,1.5,1.0,1.0), 'cm'),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        legend.position = 'none')
print(p)
```
```{r}
weekday.hours.toexport <- data.frame(hour = df$hour, weekday= df$weekdays)
write.table(weekday.hours.toexport, file = "data/weekdays_hours.csv", row.names = FALSE, quote = FALSE, sep = ",")
```

